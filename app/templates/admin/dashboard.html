<!-- filepath: app/templates/admin/dashboard.html -->
{% extends "admin/admin_base.html" %}

{% block extra_head %}
<!-- Configuraciones para JavaScript -->
<script>
    window.dashboardConfig = {{ (dashboard_config or {})|tojson }};
    window.interfaceSettings = {{ (interface_settings or {})|tojson }};
    window.metricsConfig = {{ (metrics_config or {})|tojson }};
</script>
{% endblock %}

{% block content %}
<div class="panel-header">
    <h1 class="panel-title">Panel de Control</h1>
    <div class="dashboard-controls">
        <button class="btn btn-sm btn-outline refresh-metrics" title="Actualizar">
            üîÑ Actualizar
        </button>
    </div>
</div>

{# Mostrar mensajes flash #}
{% include 'admin/_flash_messages.html' %}

<!-- Alertas de Citas Expiradas -->
{% if citas_expiradas %}
<section class="dashboard-section alert-section">
    <h2 class="section-title">üö® Citas Expiradas</h2>
    <div class="alert alert-warning">
        Hay {{ citas_expiradas|length }} citas expiradas que requieren atenci√≥n.
    </div>
    <div class="data-table-wrapper">
        <table class="data-table mobile-cards">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Tel√©fono</th>
                    <th>Barbero</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for cita in citas_expiradas %}
                <tr>
                    <td>{{ cita.cliente.nombre }}</td>
                    <td class="phone-cell">
                        {% if cita.cliente.telefono %}
                        <a href="https://wa.me/{{ cita.cliente.telefono|replace('+', '')|replace(' ', '')|replace('-', '') }}" target="_blank" class="whatsapp-link">
                            {{ cita.cliente.telefono }}
                        </a>
                        {% else %}
                        Sin tel√©fono
                        {% endif %}
                    </td>
                    <td>{{ cita.barbero.nombre }}</td>
                    <td>{{ cita.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="actions">
                        <a href="{{ url_for('admin.editar_cita', id=cita.id) }}" class="btn btn-sm">Editar</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Vista m√≥vil para citas expiradas -->
    <div class="mobile-cards-container">
        {% for cita in citas_expiradas %}
        <div class="mobile-card">
            <div class="mobile-card-header">
                <span class="mobile-card-title">{{ cita.cliente.nombre }}</span>
                <span class="mobile-card-value">{{ cita.fecha.strftime('%d/%m %H:%M') }}</span>
            </div>
            <div class="mobile-card-body">
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Tel√©fono</span>
                    <span class="mobile-card-value">
                        {% if cita.cliente.telefono %}
                        <a href="https://wa.me/{{ cita.cliente.telefono|replace('+', '')|replace(' ', '')|replace('-', '') }}" target="_blank" class="whatsapp-link">
                            {{ cita.cliente.telefono }}
                        </a>
                        {% else %}
                        Sin tel√©fono
                        {% endif %}
                    </span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Barbero</span>
                    <span class="mobile-card-value">{{ cita.barbero.nombre }}</span>
                </div>
                <div class="mobile-card-field full-width">
                    <span class="mobile-card-label">Estado</span>
                    <span class="mobile-card-value">
                        <span class="badge badge-warning">Expirada</span>
                    </span>
                </div>
            </div>
            <div class="mobile-card-actions">
                <a href="{{ url_for('admin.editar_cita', id=cita.id) }}" class="btn btn-sm">Editar</a>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="section-footer">
        <a href="{{ url_for('admin.gestionar_citas', estado='expirada') }}" class="btn">Ver todas las citas expiradas</a>
    </div>
</section>
{% endif %}

<!-- Secci√≥n de Resumen (Estad√≠sticas clave simplificadas) -->
<section class="dashboard-stats simplified">
    <div class="stats-container">
        <div class="stat-box">
            <h3>üìÖ Citas Hoy</h3>
            <p class="count">{{ citas_hoy }}</p>
            <a href="{{ url_for('admin.gestionar_citas') }}" class="btn btn-sm">Ver</a>
        </div>
        
        <div class="stat-box">
            <h3>‚è≥ Pendientes</h3>
            <p class="count">{{ citas_pendientes }}</p>
            <a href="{{ url_for('admin.gestionar_citas', estado='pendiente_confirmacion') }}" class="btn btn-sm">Ver</a>
        </div>
        
        <div class="stat-box">
            <h3>üì´ Mensajes</h3>
            <p class="count">{{ unread_messages_count }}</p>
            <a href="#" class="btn btn-sm">Ver</a>
        </div>
    </div>
</section>

<!-- Secci√≥n de Pr√≥ximas Citas (Simplificada) -->
<section class="dashboard-section">
    <h2 class="section-title">Pr√≥ximas Citas</h2>
    <div class="data-table-wrapper">
        <table class="data-table mobile-cards">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Tel√©fono</th>
                    <th>Barbero</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for cita in proximas_citas %}
                <tr>
                    <td>{{ cita.cliente.nombre }}</td>
                    <td class="phone-cell">
                        {% if cita.cliente.telefono %}
                        <a href="https://wa.me/{{ cita.cliente.telefono|replace('+', '')|replace(' ', '')|replace('-', '') }}" target="_blank" class="whatsapp-link">
                            {{ cita.cliente.telefono }}
                        </a>
                        {% else %}
                        Sin tel√©fono
                        {% endif %}
                    </td>
                    <td>{{ cita.barbero.nombre }}</td>
                    <td>{{ cita.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                        <span class="badge {% if cita.estado == 'confirmada' %}badge-success
                                           {% elif cita.estado == 'pendiente_confirmacion' %}badge-warning
                                           {% else %}badge-info{% endif %}">
                            {{ cita.estado|replace('_', ' ')|title }}
                        </span>
                    </td>
                    <td><a href="{{ url_for('admin.editar_cita', id=cita.id) }}" class="btn btn-sm">Editar</a></td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5">No hay citas pr√≥ximas</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Vista m√≥vil para pr√≥ximas citas -->
    <div class="mobile-cards-container">
        {% for cita in proximas_citas %}
        <div class="mobile-card">
            <div class="mobile-card-header">
                <span class="mobile-card-title">{{ cita.cliente.nombre }}</span>
                <span class="mobile-card-value">{{ cita.fecha.strftime('%d/%m %H:%M') }}</span>
            </div>
            <div class="mobile-card-body">
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Tel√©fono</span>
                    <span class="mobile-card-value">
                        {% if cita.cliente.telefono %}
                        <a href="https://wa.me/{{ cita.cliente.telefono|replace('+', '')|replace(' ', '')|replace('-', '') }}" target="_blank" class="whatsapp-link">
                            {{ cita.cliente.telefono }}
                        </a>
                        {% else %}
                        Sin tel√©fono
                        {% endif %}
                    </span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Barbero</span>
                    <span class="mobile-card-value">{{ cita.barbero.nombre }}</span>
                </div>
                <div class="mobile-card-field full-width">
                    <span class="mobile-card-label">Estado</span>
                    <span class="mobile-card-value">
                        <span class="badge {% if cita.estado == 'confirmada' %}badge-success{% elif cita.estado == 'pendiente_confirmacion' %}badge-warning{% else %}badge-info{% endif %}">
                            {{ cita.estado|replace('_', ' ')|title }}
                        </span>
                    </span>
                </div>
            </div>
            <div class="mobile-card-actions">
                <a href="{{ url_for('admin.editar_cita', id=cita.id) }}" class="btn btn-sm">Editar</a>
            </div>
        </div>
        {% else %}
        <div class="mobile-card"><p>No hay citas pr√≥ximas</p></div>
        {% endfor %}
    </div>
    <div class="section-footer">
        <a href="{{ url_for('admin.gestionar_citas') }}" class="btn btn-sm">Ver todas</a>
    </div>
</section>

<!-- Accesos Directos -->
<section class="dashboard-section quick-access-section">
    <h2 class="section-title">Acciones R√°pidas</h2>
    <div class="quick-access-grid simplified">
        <a href="{{ url_for('admin.gestionar_citas') }}" class="action-card">
            <div class="icon">üìÖ</div>
            <span>Todas las Citas</span>
        </a>
        
        <a href="{{ url_for('admin.gestionar_citas', estado='pendiente_confirmacion') }}" class="action-card">
            <div class="icon">‚è≥</div>
            <span>Citas Pendientes</span>
        </a>
        
        <a href="{{ url_for('admin.gestionar_citas', estado='expirada') }}" class="action-card">
            <div class="icon">üö´</div>
            <span>Citas Expiradas</span>
        </a>
        
        <a href="{{ url_for('admin.gestionar_barberos') }}" class="action-card">
            <div class="icon">üë®‚Äçüíº</div>
            <span>Barberos</span>
        </a>
        
        <a href="{{ url_for('admin.gestionar_productos') }}" class="action-card">
            <div class="icon">üì¶</div>
            <span>Productos</span>
        </a>
        
        <a href="{{ url_for('admin.gestionar_servicios') }}" class="action-card">
            <div class="icon">‚úÇÔ∏è</div>
            <span>Servicios</span>
        </a>
    </div>
</section>

<script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
<script>
    // Marcar el body como dashboard para inicializaci√≥n del script
    document.body.classList.add('admin-dashboard');
</script>

{% endblock %}