<!-- filepath: app/templates/admin/dashboard.html -->
{% extends "admin/admin_base.html" %}

{% block extra_head %}
<!-- Configuraciones para JavaScript -->
<script>
    window.dashboardConfig = {{ (dashboard_config or {})|tojson }};
    window.interfaceSettings = {{ (interface_settings or {})|tojson }};
    window.metricsConfig = {{ (metrics_config or {})|tojson }};
</script>
{% endblock %}

{% block content %}
<div class="panel-header">
    <h1 class="panel-title">{{ title }}</h1>
    <!-- NUEVO: Controles de personalizaci√≥n -->
    <div class="dashboard-controls">
        <button class="btn btn-sm btn-outline dashboard-customize" title="Personalizar Dashboard">
            ‚öôÔ∏è Personalizar
        </button>
        <button class="btn btn-sm btn-outline refresh-metrics" title="Actualizar M√©tricas">
            üîÑ Actualizar
        </button>
        {% if interface_settings and interface_settings.compact_mode %}
        <button class="btn btn-sm btn-outline compact-toggle" title="Modo Normal">
            üìñ Expandir
        </button>
        {% else %}
        <button class="btn btn-sm btn-outline compact-toggle" title="Modo Compacto">
            üì± Compacto
        </button>
        {% endif %}
    </div>
</div>

{# Mostrar mensajes flash (si los hubiera en el dashboard) #}
{% include 'admin/_flash_messages.html' %}

<!-- NUEVO: KPIs Inteligentes -->
{% if smart_kpis %}
<section class="dashboard-stats smart-kpis" data-widget="smart_kpis">
    <h2 class="section-title">üìä KPIs Personalizados</h2>
    <div class="kpi-grid">
        {% for kpi_key, kpi_data in smart_kpis.items() %}
        <div class="kpi-card {% if kpi_data.alert %}kpi-alert{% endif %}" style="--animation-delay: {{ loop.index }};">
            <div class="kpi-value" data-metric="{{ kpi_key }}">{{ kpi_data.value }}</div>
            <div class="kpi-label">{{ kpi_data.label }}</div>
            <div class="kpi-trend kpi-trend-{{ kpi_data.trend }}">
                {% if kpi_data.trend == 'up' %}üìà
                {% elif kpi_data.trend == 'down' %}üìâ
                {% else %}‚û°Ô∏è{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- NUEVO: M√©tricas de Productividad -->
{% if productivity_metrics and widgets_to_show and 'stats' in widgets_to_show %}
<section class="dashboard-stats productivity-metrics" data-widget="productivity">
    <h2 class="section-title">‚ö° M√©tricas de Productividad</h2>
    <div class="productivity-grid">
        <div class="metric-card" style="--animation-delay: 1;">
            <h3>üìà Confirmaciones</h3>
            <p class="metric-value">{{ "%.1f"|format(productivity_metrics.confirmation_rate or 0) }}%</p>
            <small>Tasa de confirmaci√≥n semanal</small>
        </div>
        <div class="metric-card" style="--animation-delay: 2;">
            <h3>üë®‚Äçüíº Barberos Activos</h3>
            <p class="metric-value">{{ productivity_metrics.active_barbers or 0 }}</p>
            <small>Disponibles para citas</small>
        </div>
        {% if productivity_metrics.low_stock_products and productivity_metrics.low_stock_products > 0 %}
        <div class="metric-card alert-card" style="--animation-delay: 3;">
            <h3>‚ö†Ô∏è Stock Bajo</h3>
            <p class="metric-value">{{ productivity_metrics.low_stock_products }}</p>
            <small>Productos requieren reposici√≥n</small>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

<!-- A. Resumen R√°pido (Estad√≠sticas Clave) -->
{% if widgets_to_show and 'stats' in widgets_to_show %}
<section class="dashboard-stats" data-widget="stats">
    <div class="card">
        <h3>Productos Totales</h3>
        <p class="count">{{ product_count }}</p>
        <a href="{{ url_for('admin.gestionar_productos') }}">Gestionar</a>
    </div>
    <div class="card">
        <h3>Barberos Registrados</h3>
        <p class="count">{{ barber_count }}</p>
        <a href="{{ url_for('admin.gestionar_barberos') }}">Gestionar</a>
    </div>
    <div class="card">
        <h3>Citas Hoy</h3>
        <p class="count">{{ citas_hoy }}</p>
        <a href="{{ url_for('admin.gestionar_citas') }}">Ver citas</a>
    </div>
    <div class="card">
        <h3>Citas este Mes</h3>
        <p class="count">{{ citas_mes }}</p>
        <a href="{{ url_for('admin.gestionar_citas') }}">Ver todas</a>
    </div>
    <div class="card">
        <h3>Mensajes Nuevos</h3>
        <p class="count">{{ unread_messages_count }}</p>
        <a href="#">Ver Mensajes</a> 
    </div>
</section>
{% endif %}

<!-- Nuevas secciones para gr√°ficos y m√©tricas -->
<div class="dashboard-charts-container">
    <!-- Gr√°fico de segmentaci√≥n de clientes -->
    <div class="dashboard-section chart-section">
        <h2 class="section-title">Segmentaci√≥n de Clientes</h2>
        <div class="chart-container">
            <canvas id="clientSegmentationChart"></canvas>
            <script type="application/json" id="clientSegmentationData">
                {
                    "labels": {{ segmentos_data.labels|tojson }},
                    "data": {{ segmentos_data.data|tojson }}
                }
            </script>
        </div>
        <div class="chart-info">
            <p>Total clientes: {{ cliente_count }}</p>
            <p><a href="{{ url_for('admin.gestionar_clientes') }}" class="btn btn-sm">Gestionar Clientes</a></p>
        </div>
    </div>
    
    <div class="dashboard-section chart-section">
        <h2 class="section-title">Rendimiento de Barberos</h2>
        <div class="chart-container">
            <canvas id="barberPerformanceChart"></canvas>
            <script type="application/json" id="barberPerformanceData">
                {
                    "names": [{% for barbero in stats_barberos %}"{{ barbero.nombre }}"{% if not loop.last %}, {% endif %}{% endfor %}],
                    "appointments": [{% for barbero in stats_barberos %}{{ barbero.citas }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    "occupation": [{% for barbero in stats_barberos %}{{ barbero.ocupacion }}{% if not loop.last %}, {% endif %}{% endfor %}]
                }
            </script>
        </div>
    </div>

    <div class="dashboard-section chart-section">
        <h2 class="section-title">Servicios M√°s Populares</h2>
        <div class="chart-container">
            <canvas id="servicePopularityChart"></canvas>
            <script type="application/json" id="serviceData">
                {
                    "labels": [{% for servicio in top_servicios %}"{{ servicio.nombre }}"{% if not loop.last %}, {% endif %}{% endfor %}],
                    "data": [{% for servicio in top_servicios %}{{ servicio.total }}{% if not loop.last %}, {% endif %}{% endfor %}]
                }
            </script>
        </div>
    </div>
</div>

<!-- Alerta de productos con bajo stock -->
{% if productos_bajo_stock %}
<section class="dashboard-section alert-section">
    <h2 class="section-title">Productos con Bajo Stock</h2>
    <div class="alert alert-warning">
        Hay {{ productos_bajo_stock|length }} productos con menos de 5 unidades en stock.
    </div>
    <div class="data-table-wrapper">
        <table class="data-table mobile-cards">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Stock Actual</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for producto in productos_bajo_stock %}
                <tr>
                    <td>{{ producto.nombre }}</td>
                    <td>
                        <span class="badge {% if producto.cantidad <= 2 %}badge-danger{% else %}badge-warning{% endif %}">
                            {{ producto.cantidad }} unidades
                        </span>
                    </td>
                    <td>
                        <a href="{{ url_for('admin.editar_producto', id=producto.id) }}" class="btn btn-sm">Actualizar stock</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Vista de tarjetas para m√≥vil -->
    <div class="mobile-cards-container">
        {% for producto in productos_bajo_stock %}
        <div class="mobile-card">
            <div class="mobile-card-body">
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Producto</span>
                    <span class="mobile-card-value">{{ producto.nombre }}</span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Stock Actual</span>
                    <span class="mobile-card-value">
                        <span class="badge {% if producto.cantidad <= 2 %}badge-danger{% else %}badge-warning{% endif %}">
                            {{ producto.cantidad }} unidades
                        </span>
                    </span>
                </div>
            </div>
            <div class="mobile-card-actions"><a href="{{ url_for('admin.editar_producto', id=producto.id) }}" class="btn btn-sm">Actualizar stock</a></div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- B. Mensajes Recientes -->
<section class="dashboard-section">
    <h2 class="section-title">Mensajes Recientes</h2>
    {% if recent_messages %}
        <ul class="recent-list">
            {% for mensaje in recent_messages %}
            <li>
                <span class="item-title">{{ mensaje.asunto or 'Sin Asunto' }}</span>
                {# Asume que tienes relaci√≥n mensaje.cliente.nombre #}
                <span class="item-meta">De: {{ mensaje.cliente.nombre if mensaje.cliente else 'Desconocido' }} - {{ mensaje.creado.strftime('%d/%m/%Y %H:%M') }}</span> 
                {# Enlace para ver el mensaje individual (requiere ruta) #}
                <a href="#" class="btn btn-small btn-secondary">Ver</a> 
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No hay mensajes recientes.</p>
    {% endif %}
     {# Enlace a la gesti√≥n completa de mensajes #}
    <div class="section-footer">
         <a href="#" class="btn btn-secondary">Ver todos los mensajes</a>
    </div>
</section>

<section class="dashboard-section">
    <h2 class="section-title">Pr√≥ximas Citas</h2>
    <div class="data-table-wrapper">
        <table class="data-table mobile-cards">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Barbero</th>
                    <th>Servicio</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for cita in proximas_citas %}
                <tr>
                    <td>{{ cita.cliente.nombre }}</td>
                    <td>{{ cita.barbero.nombre }}</td>
                    <td>{{ cita.servicio }}</td>
                    <td>{{ cita.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                        <span class="badge {% if cita.estado == 'confirmada' %}badge-success
                                           {% elif cita.estado == 'pendiente' %}badge-warning
                                           {% elif cita.estado == 'cancelada' %}badge-danger
                                           {% else %}badge-info{% endif %}">
                            {{ cita.estado }}
                        </span>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5">No hay citas pr√≥ximas</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Vista de tarjetas para m√≥vil -->
    <div class="mobile-cards-container">
        {% for cita in proximas_citas %}
        <div class="mobile-card">
            <div class="mobile-card-header">
                <span class="mobile-card-title">{{ cita.cliente.nombre }}</span>
                <span class="mobile-card-value">{{ cita.fecha.strftime('%d/%m %H:%M') }}</span>
            </div>
            <div class="mobile-card-body">
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Barbero</span>
                    <span class="mobile-card-value">{{ cita.barbero.nombre }}</span>
                </div>
                <div class="mobile-card-field">
                    <span class="mobile-card-label">Servicio</span>
                    <span class="mobile-card-value">{{ cita.servicio }}</span>
                </div>
                <div class="mobile-card-field full-width">
                    <span class="mobile-card-label">Estado</span>
                    <span class="mobile-card-value">
                        <span class="badge {% if cita.estado == 'confirmada' %}badge-success{% elif cita.estado == 'pendiente' %}badge-warning{% elif cita.estado == 'cancelada' %}badge-danger{% else %}badge-info{% endif %}">
                            {{ cita.estado }}
                        </span>
                    </span>
                </div>
            </div>
        </div>
        {% else %}
        <div class="mobile-card"><p>No hay citas pr√≥ximas</p></div>
        {% endfor %}
    </div>
    <div class="section-footer">
        <a href="{{ url_for('admin.gestionar_citas') }}" class="btn">Ver todas las citas</a>
    </div>
</section>

<!-- NUEVO: Acceso R√°pido -->
<section class="dashboard-section quick-access-section" data-widget="quick_access">
    <h2 class="section-title">üöÄ Acceso R√°pido</h2>
    <div class="quick-access-grid">
        <div class="quick-access-category">
            <h3>üìä Datos Frecuentes</h3>
            <div class="quick-items">
                <a href="{{ url_for('admin.gestionar_productos') }}" class="quick-item">
                    <span class="quick-icon">üì¶</span>
                    <span>Gestionar Productos</span>
                </a>
                <a href="{{ url_for('admin.gestionar_citas') }}" class="quick-item">
                    <span class="quick-icon">üìÖ</span>
                    <span>Gestionar Citas</span>
                </a>
                <a href="{{ url_for('admin.gestionar_clientes') }}" class="quick-item">
                    <span class="quick-icon">üë•</span>
                    <span>Gestionar Clientes</span>
                </a>
            </div>
        </div>
        
        <div class="quick-access-category">
            <h3>‚ö° Acciones R√°pidas</h3>
            <div class="quick-items">
                <button class="quick-item refresh-metrics">
                    <span class="quick-icon">üîÑ</span>
                    <span>Actualizar M√©tricas</span>
                </button>
                <button class="quick-item export-metrics">
                    <span class="quick-icon">üìã</span>
                    <span>Exportar Datos</span>
                </button>
                <button class="quick-item dashboard-customize">
                    <span class="quick-icon">‚öôÔ∏è</span>
                    <span>Personalizar</span>
                </button>
            </div>
        </div>
        
        <div class="quick-access-category">
            <h3>üìà Reportes</h3>
            <div class="quick-items">
                <a href="{{ url_for('admin.gestionar_clientes', segmento='nuevo') }}" class="quick-item">
                    <span class="quick-icon">üÜï</span>
                    <span>Clientes Nuevos</span>
                </a>
                <a href="{{ url_for('admin.gestionar_productos') }}?low_stock=1" class="quick-item">
                    <span class="quick-icon">‚ö†Ô∏è</span>
                    <span>Stock Bajo</span>
                </a>
                <a href="{{ url_for('admin.gestionar_citas', estado='pendiente_confirmacion') }}" class="quick-item">
                    <span class="quick-icon">‚è≥</span>
                    <span>Citas Pendientes</span>
                </a>
            </div>
        </div>
    </div>
</section>

<script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
<script>
    // Marcar el body como dashboard para inicializaci√≥n del script
    document.body.classList.add('admin-dashboard');
</script>

{% endblock %}